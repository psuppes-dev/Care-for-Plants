<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Care For Plants</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        :root {
            --bg: #0b1220;
            --panel: rgba(255, 255, 255, 0.06);
            --panel2: rgba(15, 23, 42, 0.70);
            --text: rgba(255, 255, 255, 0.92);
            --muted: rgba(255, 255, 255, 0.64);
            --border: rgba(255, 255, 255, 0.12);
            --shadow: 0 12px 35px rgba(0, 0, 0, 0.28);
            --radius: 18px;
            --radius-sm: 14px;
        }

        body {
            min-height: 100vh;
            background:
                radial-gradient(1200px 800px at 10% 0%, rgba(34, 197, 94, .18), transparent 60%),
                radial-gradient(900px 700px at 95% 20%, rgba(59, 130, 246, .18), transparent 55%),
                radial-gradient(900px 700px at 40% 110%, rgba(168, 85, 247, .14), transparent 55%),
                var(--bg);
            color: var(--text);
        }

        /* Layout container */
        .app-shell {
            max-width: 1200px;
        }

        /* Cards + glass panels */
        .glass {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
        }

        .glass-2 {
            background: var(--panel2);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            backdrop-filter: blur(10px);
        }

        .muted {
            color: var(--muted);
        }

        /* Navbar */
        .topbar {
            position: sticky;
            top: 0;
            z-index: 1020;
            backdrop-filter: blur(12px);
            background: rgba(11, 18, 32, .55);
            border-bottom: 1px solid rgba(255, 255, 255, .08);
        }

        .brand-dot {
            width: 10px;
            height: 10px;
            border-radius: 999px;
            background: rgb(34, 197, 94);
            box-shadow: 0 0 0 6px rgba(34, 197, 94, .12);
            display: inline-block;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: .6rem;
            font-weight: 800;
            letter-spacing: .2px;
            color: rgba(255, 255, 255, .94);
            text-decoration: none;
        }

        /* Buttons */
        .btn {
            border-radius: 14px;
            font-weight: 700;
        }

        .btn-primary {
            background: rgba(34, 197, 94, 0.95);
            border-color: rgba(34, 197, 94, 0.95);
            color: #07130c;
        }

        .btn-primary:hover {
            background: rgba(34, 197, 94, 1);
            border-color: rgba(34, 197, 94, 1);
            color: #07130c;
        }

        .btn-outline-light {
            border-color: rgba(255, 255, 255, .18);
            color: rgba(255, 255, 255, .9);
        }

        .btn-outline-light:hover {
            background: rgba(255, 255, 255, .08);
            border-color: rgba(255, 255, 255, .24);
            color: #fff;
        }

        /* Tabs (nav-pills) */
        .nav-pills .nav-link {
            border-radius: 999px;
            padding: .55rem .95rem;
            color: rgba(255, 255, 255, .78);
            border: 1px solid rgba(255, 255, 255, .10);
            background: rgba(255, 255, 255, .04);
        }

        .nav-pills .nav-link:hover {
            color: #fff;
            background: rgba(255, 255, 255, .06);
            border-color: rgba(255, 255, 255, .16);
        }

        .nav-pills .nav-link.active {
            background: rgba(34, 197, 94, .18);
            border-color: rgba(34, 197, 94, .28);
            color: rgba(255, 255, 255, .95);
        }

        /* Forms */
        .form-control,
        .form-select {
            background: rgba(255, 255, 255, .06);
            border: 1px solid rgba(255, 255, 255, .14);
            color: rgba(255, 255, 255, .92);
            border-radius: var(--radius-sm);
        }

        .form-control:focus,
        .form-select:focus {
            background: rgba(255, 255, 255, .08);
            border-color: rgba(34, 197, 94, .45);
            box-shadow: 0 0 0 .25rem rgba(34, 197, 94, .12);
            color: rgba(255, 255, 255, .92);
        }

        /* Plant cards */
        .plant-card {
            border: 1px solid rgba(255, 255, 255, .10);
            border-radius: var(--radius);
            overflow: hidden;
            background: rgba(255, 255, 255, .05);
            box-shadow: 0 10px 24px rgba(0, 0, 0, .18);
            transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
        }

        .plant-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 16px 34px rgba(0, 0, 0, .26);
            border-color: rgba(255, 255, 255, .18);
        }

        .plant-card img {
            height: 200px;
            object-fit: cover;
            filter: saturate(1.05) contrast(1.02);
        }

        /* Footer in cards */
        .card-footer {
            background: transparent !important;
            border-top: 1px solid rgba(255, 255, 255, .10);
        }

        /* Task badges */
        .task-badge {
            font-size: 0.78rem;
            margin: 2px;
            border-radius: 999px;
            padding: .35rem .55rem;
            border: 1px solid rgba(255, 255, 255, .12);
            background: rgba(255, 255, 255, .06);
            color: rgba(255, 255, 255, .88);
        }

        .task-overdue {
            background-color: rgba(220, 53, 69, .18);
            border-color: rgba(220, 53, 69, .35);
            color: rgba(255, 255, 255, .92);
        }

        .task-today {
            background-color: rgba(255, 193, 7, .20);
            border-color: rgba(255, 193, 7, .40);
            color: rgba(255, 255, 255, .92);
        }

        .task-upcoming {
            background-color: rgba(40, 167, 69, .18);
            border-color: rgba(40, 167, 69, .35);
            color: rgba(255, 255, 255, .92);
        }

        .task-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
        }

        .task-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            padding: 0.35rem 0.55rem;
            border-radius: 999px;
            white-space: nowrap;
            line-height: 1;
        }

        .task-overdue {
            background-color: #dc3545;
            color: #fff;
        }

        .task-today {
            background-color: #ffc107;
            color: #111;
        }

        .task-upcoming {
            background-color: #28a745;
            color: #fff;
        }

        /* Alerts -> glassy */
        .alert {
            border-radius: var(--radius-sm);
            border: 1px solid rgba(255, 255, 255, .12);
            background: rgba(255, 255, 255, .06);
            color: rgba(255, 255, 255, .9);
        }

        .alert-danger {
            background: rgba(220, 53, 69, .14);
            border-color: rgba(220, 53, 69, .28);
        }

        .alert-warning {
            background: rgba(255, 193, 7, .14);
            border-color: rgba(255, 193, 7, .28);
        }

        .alert-info {
            background: rgba(13, 202, 240, .12);
            border-color: rgba(13, 202, 240, .25);
        }

        /* Toxic */
        .toxic-warning {
            border: 2px solid rgba(220, 53, 69, .55) !important;
        }

        /* Modals (modern) */
        .modal-content {
            background: rgba(12, 18, 33, .92);
            border: 1px solid rgba(255, 255, 255, .12);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            color: rgba(255, 255, 255, .92);
            backdrop-filter: blur(12px);
        }

        .modal-header {
            border-bottom: 1px solid rgba(255, 255, 255, .10);
        }

        .modal-footer {
            border-top: 1px solid rgba(255, 255, 255, .10);
        }

        .btn-close {
            filter: invert(1);
            opacity: .8;
        }

        /* Subtle section dividers */
        .divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, .14), transparent);
            margin: 1rem 0;
        }

        /* Small helper chips */
        .chip {
            display: inline-flex;
            align-items: center;
            gap: .5rem;
            padding: .35rem .65rem;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, .14);
            background: rgba(255, 255, 255, .06);
            color: rgba(255, 255, 255, .86);
            font-weight: 700;
            font-size: .78rem;
        }

        /* List group restyle for calendar */
        .list-group-item {
            background: rgba(255, 255, 255, .04);
            border-color: rgba(255, 255, 255, .10);
            color: rgba(255, 255, 255, .9);
        }

        /* Make headers of bootstrap cards match the style (calendar) */
        .card-header {
            background: rgba(255, 255, 255, .04) !important;
            border-bottom: 1px solid rgba(255, 255, 255, .10);
            color: rgba(255, 255, 255, .92);
        }

        /* --- Fix: Form inputs / dropdowns readable on modern theme --- */
        .form-control,
        .form-select {
            background-color: #ffffff !important;
            color: #111827 !important;
            /* dunkler Text */
            border: 1px solid rgba(17, 24, 39, 0.15) !important;
        }

        .form-control::placeholder {
            color: rgba(17, 24, 39, 0.5) !important;
        }

        /* Dropdown options (Windows/Chrome picky) */
        select option {
            color: #111827;
            background-color: #ffffff;
        }

        /* Focus state nicer */
        .form-control:focus,
        .form-select:focus {
            border-color: rgba(34, 197, 94, 0.55) !important;
            box-shadow: 0 0 0 0.2rem rgba(34, 197, 94, 0.15) !important;
        }

        /* --- Fix: Dropdowns in Modals (wishlistSelect/locationSelect) --- */
        #addPlantModal .form-select,
        #addPlantModal select.form-select {
            background-color: #ffffff !important;
            color: #111827 !important;
            border: 1px solid rgba(17, 24, 39, 0.18) !important;
        }

        /* Option-Text erzwingen (wichtig f√ºr Windows/Chrome) */
        #addPlantModal select.form-select option,
        #addPlantModal select option {
            background-color: #ffffff !important;
            color: #111827 !important;
        }

        /* Falls du optgroups nutzt */
        #addPlantModal select.form-select optgroup {
            background-color: #ffffff !important;
            color: #111827 !important;
            font-style: normal;
        }

        /* --- Styles f√ºr die neuen Bild-Icons --- */

        .plant-icon {
            width: 20px;
            /* Feste Gr√∂√üe: Nicht zu gro√ü, nicht zu klein */
            height: 20px;
            /* Quadratisch halten */
            object-fit: contain;
            /* Verhindert, dass das Bild verzerrt wird */
            vertical-align: middle;
            /* WICHTIG: Richtet das Icon mittig zur Textzeile aus */
            margin-right: 6px;
            /* Kleiner Abstand zum Text daneben */
            display: inline-block;
            /* Damit Margin und Transform funktionieren */
        }

        /* Optional: Kleiner Hover-Effekt f√ºr Icons in Buttons */
        button:hover .plant-icon {
            transform: scale(1.15);
            /* Vergr√∂√üert das Icon leicht beim Dr√ºberfahren */
            transition: transform 0.2s ease;
        }

        /* --- Anpassung f√ºr die Badges (Die "in 5 Tagen" Anzeige) --- */
        .task-badge {
            display: inline-flex;
            /* Flexbox hilft beim Ausrichten von Bild + Text */
            align-items: center;
            /* Vertikal zentrieren */
            padding: 4px 8px;
            /* Ein bisschen Luft */
            /* Deine bestehenden Farben bleiben erhalten */
        }

        /* Spezialfall: In den Buttons unten (Gie√üen, D√ºngen etc.) 
   soll das Icon keinen Abstand nach rechts haben, da kein Text folgt. 
   (Das haben wir zwar teilweise schon im HTML per style="" gel√∂st, 
   aber das hier ist die saubere CSS-L√∂sung) */
        .btn .plant-icon {
            margin-right: 0;
        }

        .plant-icon {
            /* Gr√∂√üe relativ zur Schriftart (1.2em ist ca. Emoji-Gr√∂√üe) */
            height: 1.2em !important;
            width: auto !important;
            /* Damit sie nicht verzerrt werden */

            /* Ausrichtung perfekt zur Textlinie */
            vertical-align: text-bottom !important;

            /* Sicherheitsnetz, falls sie immer noch riesig sind */
            max-height: 20px !important;

            /* Kleiner Abstand zum Text */
            margin-right: 4px;
        }

        /* In den Buttons unten darf kein Abstand sein */
        button .plant-icon {
            margin-right: 0 !important;
        }

        /* Kleine Icons oben im Text */
        .plant-icon {
            width: 18px !important;
            height: 18px !important;
            object-fit: contain;
            vertical-align: text-bottom;
            margin-right: 5px;
        }

        /* Icons in den Buttons unten (ohne Text) */
        .btn-icon-img {
            width: 20px !important;
            height: 20px !important;
            object-fit: contain;
            display: block;
            margin: 0 auto;
            /* Zentriert das Icon */
        }

        /* Button-Gr√∂√üe b√§ndigen */
        .card-footer .btn {
            padding: 6px 10px;
            /* Weniger Polsterung */
            line-height: 1;
        }

        #userNameDisplay {
            font-weight: 600;
            color: rgba(255, 255, 255, 0.7);
            border-right: 1px solid rgba(255, 255, 255, 0.15);
            padding-right: 15px;
            margin-right: 5px;
        }

        /* --- CALENDAR STYLES --- */
        .calendar-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: #1e272e;
            /* Dunkler Hintergrund passend zur Seite */
        }

        .calendar-card:hover {
            transform: translateY(-5px) scale(1.005);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5) !important;
            border-color: rgba(255, 255, 255, 0.15) !important;
        }

        /* Der "Glow" f√ºr die Buttons */
        .action-btn {
            transition: all 0.2s ease;
            text-transform: uppercase;
            font-size: 0.7rem;
            letter-spacing: 1px;
        }

        .action-btn:hover {
            transform: scale(1.08);
            filter: brightness(1.2);
            box-shadow: 0 0 15px rgba(46, 213, 115, 0.4) !important;
        }

        /* Hover-Effekt f√ºr die einzelnen Zeilen (Dark Mode kompatibel) */
        .list-group-item {
            transition: background-color 0.2s ease;
        }

        .list-group-item:hover {
            background-color: rgba(255, 255, 255, 0.03) !important;
        }

        /* Icon-Box Veredelung */
        .icon-box {
            transition: transform 0.2s ease;
        }

        .calendar-card:hover .icon-box {
            transform: rotate(-5deg) scale(1.1);
        }
    </style>
</head>

<body>
    <!-- Login Overlay -->
    <div id="loginOverlay"
        style="position:fixed;inset:0;background:#0b1220;display:flex;align-items:center;justify-content:center;z-index:9999;">
        <div class="card p-4" style="width:320px">
            <h4 class="mb-3 text-center">Login</h4>

            <input id="loginUser" class="form-control mb-2" placeholder="Username">
            <input id="loginPass" type="password" class="form-control mb-3" placeholder="Password">

            <button class="btn btn-success w-100" onclick="login()">Login</button>

            <div class="text-muted small mt-3 text-center">
                Test-Accounts:<br>
                student / student123<br>
                tutor / tutor123
            </div>
        </div>
    </div>

    <!-- Topbar -->
    <div class="topbar py-3">
        <div class="container app-shell d-flex align-items-center justify-content-between">
            <a class="brand" href="#">
                <span class="brand-dot"></span>
                Care for Plants
            </a>
            <div class="d-flex align-items-center gap-3">
                <span id="userNameDisplay" class="text-white-50 small d-none"></span>
                <button id="logoutBtn" class="btn btn-sm btn-outline-danger" onclick="logout()" style="display:none;">
                    Abmelden
                </button>
            </div>
        </div>
    </div>

    <div class="container app-shell py-4 py-md-5">
        <!-- Hero -->
        <div class="glass p-4 p-md-5 mb-4">
            <div class="row g-4 align-items-center">
                <div class="col-md-8">
                    <h1 class="display-6 fw-bold mb-2">Care for Plants ‚Äì Deine Pflanzenpflege √ºbersichtlich organisiert
                    </h1>
                </div>
                <div class="col-md-4">
                    <div class="glass-2 p-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="fw-bold">Quick Actions</div>
                                <div class="muted small">F√ºr Demo & Alltag</div>
                            </div>
                        </div>
                        <div class="divider"></div>
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" onclick="showAddPlantModal()">Pflanze hinzuf√ºgen</button>
                            <button class="btn btn-outline-light" onclick="showSearchModal()">Pflanze suchen</button>
                            <button class="btn btn-outline-light" onclick="showAddLocationModal()">Standort
                                anlegen</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-pills gap-2 mb-4" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard"
                    type="button">Dashboard</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="wishlist-tab" data-bs-toggle="tab" data-bs-target="#wishlist"
                    type="button">Wunschliste</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="locations-tab" data-bs-toggle="tab" data-bs-target="#locations"
                    type="button">Standorte</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="calendar-tab" data-bs-toggle="tab" data-bs-target="#calendar"
                    type="button">Kalender</button>
            </li>
        </ul>

        <div class="tab-content">
            <!-- TAB 1: Dashboard -->
            <div class="tab-pane fade show active" id="dashboard">
                <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
                    <div>
                        <div class="fw-bold">Dashboard</div>
                        <div class="muted small">Pflegeaufgaben pro Pflanze</div>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-light" onclick="loadTasks()">Aktualisieren</button>
                        <button class="btn btn-primary" onclick="showAddPlantModal()">Pflanze hinzuf√ºgen</button>
                    </div>
                </div>
                <div id="plant-container" class="row g-4"></div>
            </div>

            <!-- TAB 2: Wunschliste -->
            <div class="tab-pane fade" id="wishlist">
                <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
                    <div>
                        <div class="fw-bold">Wunschliste</div>
                        <div class="muted small">Pflanzen entdecken, speichern, bearbeiten</div>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-light" onclick="loadWishlist()">Aktualisieren</button>
                        <button class="btn btn-primary" onclick="showSearchModal()">Pflanze suchen</button>
                    </div>
                </div>
                <div id="wishlist-container" class="row g-4"></div>
            </div>

            <!-- TAB 3: Standorte -->
            <div class="tab-pane fade" id="locations">
                <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
                    <div>
                        <div class="fw-bold">Standorte</div>
                        <div class="muted small">Bedingungen festlegen und passende Pflanzen sehen</div>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-light" onclick="loadLocations()">Aktualisieren</button>
                        <button class="btn btn-primary" onclick="showAddLocationModal()">Standort anlegen</button>
                    </div>
                </div>
                <div id="locations-container" class="row g-4"></div>
            </div>

            <!-- TAB 4: Kalender -->
            <div class="tab-pane fade" id="calendar">
                <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
                    <div>
                        <div class="fw-bold">Kalender</div>
                        <div class="muted small">Aufgaben der n√§chsten Tage, gruppiert nach Datum</div>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-light" onclick="loadCalendar()">Aktualisieren</button>
                    </div>
                </div>
                <div id="calendar-container"></div>
            </div>
        </div>
    </div>

    <!-- Modal: Pflanze hinzuf√ºgen -->
    <div class="modal fade" id="addPlantModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Pflanze hinzuf√ºgen</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label muted">Pflanze aus Wunschliste</label>
                        <select id="wishlistSelect" class="form-select"></select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label muted">Spitzname</label>
                        <input type="text" id="plantNickname" class="form-control" placeholder="z.B. Meine Monstera">
                    </div>
                    <div class="mb-3">
                        <label class="form-label muted">Standort</label>
                        <select id="locationSelect" class="form-select"></select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="button" class="btn btn-primary" onclick="addPlantFromWishlist()">Hinzuf√ºgen</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Pflanze suchen -->
    <div class="modal fade" id="searchModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Pflanze suchen</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <input type="text" id="searchInput" class="form-control"
                            placeholder="z.B. Monstera, Rose, Basilikum...">
                        <button class="btn btn-primary mt-2 w-100" onclick="searchPlants()">Suchen</button>
                    </div>
                    <div id="searchResults" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Standort anlegen -->
    <div class="modal fade" id="addLocationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Neuer Standort</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label muted">Name</label>
                        <input type="text" id="locationName" class="form-control" placeholder="z.B. Balkon">
                    </div>
                    <div class="mb-3">
                        <label class="form-label muted">Lichtverh√§ltnisse (1-10)</label>
                        <input type="number" id="locationLight" class="form-control" min="1" max="10" value="5">
                        <small class="muted">1 = dunkel, 10 = volle Sonne</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label muted">Luftfeuchtigkeit (1-10)</label>
                        <input type="number" id="locationHumidity" class="form-control" min="1" max="10" value="5">
                        <small class="muted">1 = sehr trocken, 10 = sehr feucht</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label muted">Durchschnittstemperatur (¬∞C)</label>
                        <input type="number" id="locationTemp" class="form-control" value="20">
                    </div>
                    <div class="mb-3">
                        <label class="form-label muted">Verf√ºgbare H√∂he (cm)</label>
                        <input type="number" id="locationSpace" class="form-control" value="200">
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="locationPets">
                        <label class="form-check-label muted" for="locationPets">Haustiere oder Kinder vorhanden</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="button" class="btn btn-primary" onclick="createLocation()">Anlegen</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Pflanzeneigenschaften bearbeiten -->
    <div class="modal fade" id="editPlantModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Eigenschaften bearbeiten</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editWishlistId">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label muted">Gie√üen (alle X Tage)</label>
                            <input type="number" id="editWater" class="form-control">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label muted">D√ºngen (alle X Tage)</label>
                            <input type="number" id="editFertilize" class="form-control">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label muted">Lichtbedarf (1-10)</label>
                            <input type="number" id="editLight" class="form-control" min="1" max="10">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label muted">Luftfeuchtigkeit (1-10)</label>
                            <input type="number" id="editHumidity" class="form-control" min="1" max="10">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label muted">Min. Temperatur (¬∞C)</label>
                            <input type="number" id="editTempMin" class="form-control">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label muted">Max. Temperatur (¬∞C)</label>
                            <input type="number" id="editTempMax" class="form-control">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label muted">Max. H√∂he (cm)</label>
                            <input type="number" id="editHeight" class="form-control">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label muted">Bodenart</label>
                            <select id="editSoil" class="form-select">
                                <option value="universal">Universal</option>
                                <option value="sandig">Sandig</option>
                                <option value="lehmig">Lehmig</option>
                                <option value="humusreich">Humusreich</option>
                            </select>
                        </div>
                        <div class="col-12 mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="editToxic">
                            <label class="form-check-label muted" for="editToxic">Giftig f√ºr Haustiere/Kinder</label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="button" class="btn btn-primary" onclick="savePlantEdit()">Speichern</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Standort-Details -->
    <div class="modal fade" id="locationDetailModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="locationDetailTitle">Standort Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="locationDetailContent"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Standort-Wechsel -->
    <div class="modal fade" id="movePlantModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Standort wechseln</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="move-plant-id">
                    <label class="form-label muted">Neuer Standort</label>
                    <select class="form-select" id="move-location-select"></select>
                    <div id="move-warning" class="alert alert-warning mt-3 d-none"></div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline-light" data-bs-dismiss="modal">Abbrechen</button>
                    <button class="btn btn-primary" onclick="submitMovePlant()">Speichern</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const API_URL =
            (window.location.port === "5500" || window.location.port === "5501")
                ? "http://127.0.0.1:8000"
                : window.location.origin;

        let editSource = "wishlist";
        let moveModal;
        let moveRecommendations = [];

        // ---------- DASHBOARD LADEN ----------
        async function loadTasks() {
            const container = document.getElementById('plant-container');
            if (!container) return;
            container.innerHTML = '<div class="col-12 text-center muted">Lade Daten...</div>';

            try {
                const response = await fetch(`${API_URL}/dashboard/tasks`);
                const tasks = await response.json();
                container.innerHTML = "";

                if (tasks.length === 0) {
                    container.innerHTML = '<div class="col-12 text-center">Noch keine Pflanzen da. F√ºge welche hinzu!</div>';
                    return;
                }

                const taskIcons = {
                    'water': '<img src="img/icons/water.png" class="plant-icon" alt="üíß">',
                    'fertilize': '<img src="img/icons/fertilize.png" class="plant-icon" alt="‚ö°">',
                    'repot': '<img src="img/icons/pot.png" class="plant-icon" alt="ü™¥">',
                    'prune': '<img src="img/icons/scissors.png" class="plant-icon" alt="‚úÇÔ∏è">',
                    'propagate': '<img src="img/icons/multiply.png" class="plant-icon" alt="üå±">'
                };

                const taskNames = { 'water': 'Gie√üen', 'fertilize': 'D√ºngen', 'repot': 'Umtopfen', 'prune': 'Schneiden', 'propagate': 'Vermehren' };

                const createTaskBadge = (name, icon, days) => {
                    let badgeClass = 'task-upcoming';
                    let text = `in ${days}d`;
                    if (days < 0) {
                        badgeClass = 'task-overdue';
                        text = `${Math.abs(days)}d √ºberf√§llig`;
                    } else if (days === 0) {
                        badgeClass = 'task-today';
                        text = 'HEUTE';
                    }
                    return `<span class="task-badge ${badgeClass}">${icon} ${name}: ${text}</span>`;
                };

                tasks.forEach(task => {
                    const safeInfo = JSON.stringify(task.plant_info_full).replace(/"/g, '&quot;');
                    const isToxic = task.plant_info_full && task.plant_info_full.is_toxic;
                    const toxicClass = isToxic ? 'toxic-warning' : '';
                    const toxicBadge = isToxic ? '<span class="badge bg-danger ms-2">GIFTIG</span>' : '';

                    const taskBadges = `
                    ${createTaskBadge('Gie√üen', taskIcons.water, task.days_until_watering)}
                    ${createTaskBadge('D√ºngen', taskIcons.fertilize, task.days_until_fertilizing)}
                    ${createTaskBadge('Umtopfen', taskIcons.repot, task.days_until_repotting)}
                    ${createTaskBadge('Schneiden', taskIcons.prune, task.days_until_pruning)}
                    ${createTaskBadge('Vermehren', taskIcons.propagate, task.days_until_propagating)}
                `;

                    const nextTaskIcon = taskIcons[task.next_task] || '';
                    const nextTaskName = taskNames[task.next_task] || 'Unbekannt';

                    const cardHtml = `
                <div class="col-lg-4 col-md-6 mb-4">
                  <div class="plant-card h-100 ${toxicClass}">
                    <img src="${task.image || 'https://via.placeholder.com/300?text=Kein+Bild'}" class="w-100" style="height: 200px; object-fit: cover;">
                    <div class="p-3">
                      <h5 class="mb-1 d-flex align-items-center">${task.plant} ${toxicBadge}</h5>
                      <div class="muted small mb-2">${task.species}</div>
                      <div class="mb-2"><span class="chip">üìç ${task.location}</span></div>
                      <div class="task-badges mb-2 d-flex flex-column align-items-start gap-1">${taskBadges}</div>
                      <div class="alert ${task.next_task_days < 0 ? 'alert-danger' : task.next_task_days === 0 ? 'alert-warning' : 'alert-info'} py-2 mb-0 mt-3 w-100">
                        <strong>N√§chste Aufgabe:</strong> ${nextTaskIcon} ${nextTaskName}
                      </div>
                    </div>
                   <div class="card-footer p-2 bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-primary" onclick="waterPlant(${task.id})" title="Gie√üen"><img src="img/icons/water.png" class="btn-icon-img"></button>
                            <button class="btn btn-sm btn-success" onclick="fertilizePlant(${task.id})" title="D√ºngen"><img src="img/icons/fertilize.png" class="btn-icon-img"></button>
                            <button class="btn btn-sm btn-warning" onclick="repotPlant(${task.id})" title="Umtopfen"><img src="img/icons/pot.png" class="btn-icon-img"></button>
                            <button class="btn btn-sm btn-info" onclick="prunePlant(${task.id})" title="Schneiden"><img src="img/icons/scissors.png" class="btn-icon-img"></button>
                            <button class="btn btn-sm btn-secondary" onclick="propagatePlant(${task.id})" title="Vermehren"><img src="img/icons/multiply.png" class="btn-icon-img"></button>
                        </div>
                        <div class="btn-group ms-1" role="group">
                            <button class="btn btn-sm btn-outline-info" onclick="showEditModalFromDashboard(${task.id}, ${safeInfo})" title="Eigenschaften">‚öôÔ∏è</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="openMovePlantModal(${task.id})" title="Standort wechseln"><img src="img/icons/swap.png" class="btn-icon-img"></button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteMyPlant(${task.id})" title="Pflanze l√∂schen"><img src="img/icons/delete.png" class="btn-icon-img"></button>
                        </div>
                    </div>
                    </div>
                  </div>
                </div>`;
                    container.innerHTML += cardHtml;
                });
            } catch (error) { console.error("Dashboard Fehler:", error); }
        }

        // ---------- EDIT LOGIK ----------
        function showEditModalFromDashboard(id, info) {
            editSource = "dashboard";
            document.getElementById('editWishlistId').value = id;
            document.getElementById('editWater').value = info.water_frequency_days;
            document.getElementById('editFertilize').value = info.fertilize_frequency_days;
            document.getElementById('editLight').value = info.sunlight_requirement;
            document.getElementById('editHumidity').value = info.humidity_requirement;
            document.getElementById('editTempMin').value = info.temperature_min;
            document.getElementById('editTempMax').value = info.temperature_max;
            document.getElementById('editHeight').value = info.max_height_cm;
            document.getElementById('editSoil').value = info.soil_type;
            document.getElementById('editToxic').checked = info.is_toxic;
            new bootstrap.Modal(document.getElementById('editPlantModal')).show();
        }

        async function savePlantEdit() {
            const id = document.getElementById('editWishlistId').value;
            const url = editSource === "dashboard" ? `${API_URL}/my-plants/${id}/plant-info` : `${API_URL}/wishlist/${id}/plant-info`;
            const payload = {
                water_frequency_days: parseInt(document.getElementById('editWater').value),
                fertilize_frequency_days: parseInt(document.getElementById('editFertilize').value),
                sunlight_requirement: parseInt(document.getElementById('editLight').value),
                humidity_requirement: parseInt(document.getElementById('editHumidity').value),
                temperature_min: parseInt(document.getElementById('editTempMin').value),
                temperature_max: parseInt(document.getElementById('editTempMax').value),
                max_height_cm: parseInt(document.getElementById('editHeight').value),
                soil_type: document.getElementById('editSoil').value,
                is_toxic: document.getElementById('editToxic').checked
            };
            try {
                const res = await fetch(url, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (res.ok) {
                    alert('‚úÖ Gespeichert!');
                    bootstrap.Modal.getInstance(document.getElementById('editPlantModal')).hide();
                    editSource === "dashboard" ? loadTasks() : loadWishlist();
                }
            } catch (e) { console.error(e); }
        }

        // ---------- STANDORT WECHSELN ----------
        async function openMovePlantModal(plantId) {
            document.getElementById('move-plant-id').value = plantId;
            const res = await fetch(`${API_URL}/my-plants/${plantId}/recommended-locations`);
            const locations = await res.json();
            moveRecommendations = locations;
            const sel = document.getElementById('move-location-select');
            sel.innerHTML = '';
            const good = document.createElement('optgroup'); good.label = '‚úÖ Empfohlen';
            const other = document.createElement('optgroup'); other.label = '‚ö†Ô∏è Nicht ideal';
            locations.forEach(l => {
                const opt = document.createElement('option'); opt.value = l.id;
                opt.textContent = l.recommended ? l.name : `${l.name} (${l.reasons.join(", ")})`;
                (l.recommended ? good : other).appendChild(opt);
            });
            sel.appendChild(good); sel.appendChild(other);
            updateMoveWarning();
            sel.onchange = updateMoveWarning;
            if (!moveModal) moveModal = new bootstrap.Modal(document.getElementById('movePlantModal'));
            moveModal.show();
        }

        function updateMoveWarning() {
            const sel = document.getElementById('move-location-select');
            const info = moveRecommendations.find(x => x.id === parseInt(sel.value));
            const warn = document.getElementById('move-warning');
            if (info && !info.recommended) {
                warn.classList.remove('d-none');
                warn.textContent = `‚ö†Ô∏è Hinweis: ${info.reasons.join(", ")}`;
            } else if (warn) { warn.classList.add('d-none'); }
        }

        async function submitMovePlant() {
            const plantId = document.getElementById('move-plant-id').value;
            const newLocId = parseInt(document.getElementById('move-location-select').value);
            await fetch(`${API_URL}/my-plants/${plantId}/move`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ location_id: newLocId }) });
            moveModal.hide(); loadTasks();
        }

        // ---------- PFLEGE AKTIONEN ----------
        async function performTask(plantId, taskType, emoji, name) {
            try {
                const response = await fetch(`${API_URL}/my-plants/${plantId}/${taskType}`, { method: 'POST' });
                if (response.ok) { alert(`${emoji} ${name} erledigt!`); loadTasks(); loadCalendar(); }
            } catch (error) { alert('‚ùå Fehler: ' + error); }
        }

        async function waterPlant(id) { await performTask(id, 'water', 'üíß', 'Gie√üen'); }
        async function fertilizePlant(id) { await performTask(id, 'fertilize', 'üå±', 'D√ºngen'); }
        async function repotPlant(id) { await performTask(id, 'repot', 'ü™¥', 'Umtopfen'); }
        async function prunePlant(id) { await performTask(id, 'prune', '‚úÇÔ∏è', 'Schneiden'); }
        async function propagatePlant(id) {
            const count = prompt("Wie viele Ableger?", "1");
            if (count === null || isNaN(count) || parseInt(count) <= 0) return;
            const res = await fetch(`${API_URL}/my-plants/${id}/propagate?count=${parseInt(count)}`, { method: 'POST' });
            if (res.ok) { alert(`üå± ${count} Ableger erstellt!`); loadTasks(); loadCalendar(); }
        }

        async function deleteMyPlant(id) {
            if (confirm("Wirklich l√∂schen?")) { await fetch(`${API_URL}/my-plants/${id}`, { method: 'DELETE' }); loadTasks(); }
        }

        // ---------- WUNSCHLISTE ----------
        async function loadWishlist() {
            const container = document.getElementById('wishlist-container');
            if (!container) return;
            container.innerHTML = '<div class="col-12 text-center muted">Lade Wunschliste...</div>';
            try {
                const res = await fetch(`${API_URL}/wishlist/`);
                const wishlist = await res.json();
                container.innerHTML = "";
                wishlist.forEach(item => {
                    const suitableText = item.suitable_locations.length > 0 ? `‚úÖ Geeignet f√ºr: ${item.suitable_locations.join(', ')}` : '‚ö†Ô∏è Nicht ideal';
                    const toxicBadge = item.is_toxic ? '<span class="badge bg-danger">GIFTIG</span>' : '';
                    const safeJson = JSON.stringify(item).replace(/"/g, '&quot;');

                    container.innerHTML += `
            <div class="col-md-4 mb-4">
                <div class="plant-card h-100 ${item.is_toxic ? 'toxic-warning' : ''}">
                    <img src="${item.image_url || 'https://via.placeholder.com/300'}" class="w-100" style="height:200px; object-fit:cover;">
                    <div class="p-3">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h5 class="mb-0">${item.common_name || item.scientific_name}</h5>
                            ${toxicBadge}
                        </div>
                        <div class="muted small mb-2">${item.scientific_name}</div>
                        <div class="divider"></div>
                        
                        <div class="muted small">
                            ‚òÄÔ∏è Licht: ${item.sunlight_requirement}/10 ‚Ä¢ üíß Feuchtigkeit: ${item.humidity_requirement}/10<br>
                            üå°Ô∏è Temperatur: ${item.temperature_min}-${item.temperature_max}¬∞C<br>
                            üìè Max. H√∂he: ${item.max_height_cm}cm ‚Ä¢ üå± Boden: ${item.soil_type}<br>
                            üíß Gie√üen: alle ${item.water_frequency_days} Tage
                        </div>

                        <div class="mt-2"><span class="chip">${suitableText}</span></div>
                    </div>
                    <div class="card-footer p-3">
                        <button class="btn btn-sm btn-outline-light w-100 mb-2" onclick="showEditPlantModal(${item.id}, ${safeJson})">Bearbeiten</button>
                        <button class="btn btn-sm btn-primary w-100" onclick="removeFromWishlist(${item.id})">Entfernen</button>
                    </div>
                </div>
            </div>`;
                })
            } catch (e) { console.error(e); }
        }

        function showEditPlantModal(wishlistId, plant) {
            editSource = "wishlist";
            document.getElementById('editWishlistId').value = wishlistId;
            document.getElementById('editWater').value = plant.water_frequency_days || 7;
            document.getElementById('editFertilize').value = plant.fertilize_frequency_days || 30;
            document.getElementById('editLight').value = plant.sunlight_requirement || 5;
            document.getElementById('editHumidity').value = plant.humidity_requirement || 5;
            document.getElementById('editTempMin').value = plant.temperature_min || 15;
            document.getElementById('editTempMax').value = plant.temperature_max || 25;
            document.getElementById('editHeight').value = plant.max_height_cm || 100;
            document.getElementById('editSoil').value = plant.soil_type || 'universal';
            document.getElementById('editToxic').checked = plant.is_toxic;
            new bootstrap.Modal(document.getElementById('editPlantModal')).show();
        }

        async function removeFromWishlist(id) {
            if (!confirm('Wirklich entfernen?')) return;
            await fetch(`${API_URL}/wishlist/${id}`, { method: 'DELETE' }); loadWishlist();
        }

        // ---------- STANDORTE ----------
        async function loadLocations() {
            const container = document.getElementById('locations-container');
            if (!container) return;
            try {
                const res = await fetch(`${API_URL}/locations/`);
                const locs = await res.json();
                container.innerHTML = "";
                const detailRes = await Promise.all(locs.map(l => fetch(`${API_URL}/locations/${l.id}/details`).then(r => r.json())));
                locs.forEach((l, idx) => {
                    const data = detailRes[idx];
                    const pets = l.has_pets_or_children ? '<span class="badge bg-warning text-dark">Haustiere/Kinder</span>' : ''; ss =
                        container.innerHTML += `<div class="col-md-4"><div class="plant-card h-100"><div cla"p-3"><h5 class="text-center fw-bold">${l.name} ${pets}</h5><div class="d-flex gap-2 flex-wrap mb-3"><span class="chip">Vorhanden: ${data.actual_plants.length}</span><span class="chip">Wishlist passend: ${data.compatible_wishlist_plants.length}</span></div><div class="muted small">‚òÄÔ∏è Licht: ${l.light_level}/10 ‚Ä¢ üíß Feuchtigkeit: ${l.humidity_level}/10<br>üå°Ô∏è Temperatur: ${l.temperature_avg}¬∞C ‚Ä¢ üìè Platz: ${l.available_space_cm}cm</div><div class="divider"></div><button class="btn btn-outline-light w-100" onclick="showLocationDetails(${l.id})">Details anzeigen</button></div></div></div>`;
                });
            } catch (e) { console.error(e); }
        }

        async function showLocationDetails(locationId) {
            try {
                const response = await fetch(`${API_URL}/locations/${locationId}/details`);
                const data = await response.json();
                document.getElementById('locationDetailTitle').textContent = data.location.name;

                // --- Vorhandene Pflanzen ---
                let html = '<h5 class="mb-3 text-white">Vorhandene Pflanzen</h5><div class="row g-3 mb-4">';
                if (data.actual_plants.length === 0) {
                    html += '<div class="col-12 text-muted small italic">Keine Pflanzen an diesem Standort.</div>';
                } else {
                    data.actual_plants.forEach(p => {
                        html += `
                        <div class="col-md-3">
                            <div class="plant-card" style="background: rgba(255,255,255,0.03); border: 1px solid #ffffff10;">
                                <img src="${p.image || 'https://via.placeholder.com/150'}" class="w-100" style="height: 100px; object-fit: cover; border-radius: 8px 8px 0 0;">
                                <div class="p-2">
                                    <div class="fw-bold text-white small">${p.nickname}</div>
                                    <div class="muted extra-small">${p.species}</div>
                                </div>
                            </div>
                        </div>`;
                    });
                }
                html += '</div>';

                // --- Passende Wunschliste ---
                html += '<h5 class="mb-3 text-white">Passende Pflanzen aus deiner Wunschliste</h5><div class="row g-3">';
                if (data.compatible_wishlist_plants.length === 0) {
                    html += '<div class="col-12 alert alert-info bg-dark text-info border-info opacity-75">Keine passenden Pflanzen gefunden.</div>';
                } else {
                    data.compatible_wishlist_plants.forEach(p => {
                        // Hier f√ºgen wir den "EINZIEHEN" Button ein
                        html += `
                        <div class="col-md-3">
                            <div class="plant-card h-100" style="border-color: rgba(34,197,94,.4); background: rgba(0,0,0,0.2);">
                                <img src="${p.image || 'https://via.placeholder.com/150'}" class="w-100" style="height: 100px; object-fit: cover; border-radius: 8px 8px 0 0;">
                                <div class="p-2">
                                    <div class="fw-bold text-white small text-truncate">${p.common_name || p.scientific_name}</div>
                                    <div class="muted extra-small mb-2">${p.scientific_name}</div>
                                    
                                    <button class="btn btn-sm btn-success w-100 py-1 action-btn" 
                                            style="font-size: 0.7rem; letter-spacing: 0.5px;"
                                            onclick="quickAddFromWishlist(${p.wishlist_id}, ${locationId}, '${p.common_name || p.scientific_name}')">
                                        EINZIEHEN
                                    </button>
                                </div>
                            </div>
                        </div>`;
                    });
                }
                html += '</div>';

                document.getElementById('locationDetailContent').innerHTML = html;
                new bootstrap.Modal(document.getElementById('locationDetailModal')).show();
            } catch (e) { console.error(e); }
        }

        async function quickAddFromWishlist(wishlistId, locationId, plantName) {
            if (!confirm(`${plantName} an diesen Standort verschieben?`)) return;

            const payload = {
                nickname: plantName,
                location_id: parseInt(locationId),
                wishlist_id: parseInt(wishlistId)
            };

            try {
                const res = await fetch(`${API_URL}/my-plants/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    // Modal schlie√üen
                    const modalElement = document.getElementById('locationDetailModal');
                    const modal = bootstrap.Modal.getInstance(modalElement);
                    if (modal) modal.hide();

                    // Alles aktualisieren
                    await loadLocations(); // Wichtig, um die neue Anzahl im Standort-Tab zu sehen
                    if (typeof loadTasks === 'function') loadTasks(); // Dashboard aktualisieren

                    alert(`üéâ ${plantName} wurde erfolgreich hinzugef√ºgt!`);
                }
            } catch (e) { console.error(e); }
        }

        // ---------- PFLANZE HINZUF√úGEN (FIXED) ----------
        async function showAddPlantModal() {
            try {
                const [wishRes, locRes] = await Promise.all([fetch(`${API_URL}/wishlist/`, { credentials: "include" }), fetch(`${API_URL}/locations/`, { credentials: "include" })]);
                const wishlist = await wishRes.json();
                const locations = await locRes.json();
                const wishSelect = document.getElementById('wishlistSelect');
                const locSelect = document.getElementById('locationSelect');
                wishSelect.innerHTML = "";
                if (wishlist.length === 0) { alert("Wunschliste ist leer."); return; }
                wishlist.forEach(item => {
                    const opt = document.createElement('option'); opt.value = item.id;
                    opt.dataset.suitable = JSON.stringify(item.suitable_locations);
                    opt.text = item.common_name ? `${item.common_name} (${item.scientific_name})` : item.scientific_name;
                    wishSelect.appendChild(opt);
                });
                const updateLocDropdown = () => {
                    const suitableNames = JSON.parse(wishSelect.options[wishSelect.selectedIndex].dataset.suitable || "[]");
                    locSelect.innerHTML = "";
                    const good = document.createElement('optgroup'); good.label = '‚úÖ Empfohlen';
                    const other = document.createElement('optgroup'); other.label = '‚ö†Ô∏è Nicht ideal';
                    locations.forEach(loc => {
                        const opt = document.createElement('option'); opt.value = loc.id;
                        const isSuitable = suitableNames.includes(loc.name);
                        opt.text = isSuitable ? loc.name : `${loc.name} (abweichend)`;
                        (isSuitable ? good : other).appendChild(opt);
                    });
                    if (good.children.length) locSelect.appendChild(good);
                    if (other.children.length) locSelect.appendChild(other);
                };
                wishSelect.onchange = updateLocDropdown; updateLocDropdown();
                new bootstrap.Modal(document.getElementById('addPlantModal')).show();
            } catch (error) { console.error(error); }
        }

        async function addPlantFromWishlist() {
            const wishId = document.getElementById('wishlistSelect').value;
            const locationId = document.getElementById('locationSelect').value;
            const nickname = document.getElementById('plantNickname').value;

            if (!locationId || !wishId) {
                alert("Bitte Standort und Pflanze w√§hlen.");
                return;
            }

            // Das Payload-Objekt muss EXAKT zu MyPlantCreate Klasse im Backend passen
            const payload = {
                nickname: nickname || "Meine Pflanze",
                location_id: parseInt(locationId),
                wishlist_id: parseInt(wishId)
            };

            try {
                const response = await fetch(`${API_URL}/my-plants/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    alert('‚úÖ Pflanze erfolgreich eingezogen!');
                    // Modal schlie√üen
                    bootstrap.Modal.getInstance(document.getElementById('addPlantModal')).hide();
                    // Dashboard und Wunschliste neu laden
                    loadTasks();
                    if (typeof loadWishlist === 'function') loadWishlist();
                } else {
                    const err = await response.json();
                    alert('Fehler: ' + (err.detail || 'Konnte Pflanze nicht hinzuf√ºgen'));
                }
            } catch (error) {
                console.error("Add Plant Error:", error);
                alert("Verbindung zum Server fehlgeschlagen.");
            }
        }

        // ---------- KALENDER ----------
        async function loadCalendar(days = 14) {
            const container = document.getElementById('calendar-container');
            if (!container) return;

            // UI Config
            const taskIcons = {
                'water': '<img src="img/icons/water.png" class="plant-icon" style="width:20px; height:20px;">',
                'fertilize': '<img src="img/icons/fertilize.png" class="plant-icon" style="width:20px; height:20px;">',
                'repot': '<img src="img/icons/pot.png" class="plant-icon" style="width:20px; height:20px;">',
                'prune': '<img src="img/icons/scissors.png" class="plant-icon" style="width:20px; height:20px;">',
                'propagate': '<img src="img/icons/multiply.png" class="plant-icon" style="width:20px; height:20px;">'
            };
            const taskNames = { water: 'Gie√üen', fertilize: 'D√ºngen', repot: 'Umtopfen', prune: 'Schneiden', propagate: 'Vermehren' };

            container.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-2 muted">Synchronisiere Zeitplan...</p></div>';

            try {
                const res = await fetch(`${API_URL}/dashboard/tasks`);
                const plants = await res.json();
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const items = [];
                plants.forEach(p => {
                    [['water', 'days_until_watering'], ['fertilize', 'days_until_fertilizing'], ['repot', 'days_until_repotting'], ['prune', 'days_until_pruning'], ['propagate', 'days_until_propagating']].forEach(([type, field]) => {
                        const d = p[field];
                        if (d !== undefined && d !== null && d <= days) {
                            const due = new Date(today);
                            due.setDate(today.getDate() + d);
                            items.push({ due, daysUntil: d, type, plant: p.plant, plantId: p.id, location: p.location });
                        }
                    });
                });

                items.sort((a, b) => a.due - b.due);
                const groups = {};
                items.forEach(it => {
                    const k = it.due.toISOString().slice(0, 10);
                    if (!groups[k]) groups[k] = { date: it.due, items: [] };
                    groups[k].items.push(it);
                });

                let html = "";
                Object.keys(groups).sort().forEach(k => {
                    const g = groups[k];
                    const diff = g.items[0].daysUntil;

                    // --- STYLE ---
                    let borderColor = "#2d3436"; // Subtiles Anthrazit
                    let statusLabel = "";
                    let accentColor = "#b2bec3"; // Sanftes Grau f√ºr Text

                    if (diff < 0) {
                        // √úBERF√ÑLLIG (Rot)
                        borderColor = "#ff4757";
                        accentColor = "#ff4757";
                        statusLabel = '<span class="badge rounded-pill bg-danger me-2 shadow-sm" style="letter-spacing:1px;">√úBERF√ÑLLIG</span>';
                    } else if (diff === 0) {
                        // HEUTE (Gelb - Warning)
                        borderColor = "#ffa502";
                        accentColor = "#ffa502";
                        statusLabel = '<span class="badge rounded-pill bg-warning text-dark me-2 shadow-sm" style="letter-spacing:1px;">HEUTE</span>';
                    } else if (diff === 1) {
                        // MORGEN (Info-Blau)
                        borderColor = "#1e90ff";
                        accentColor = "#1e90ff";
                        statusLabel = '<span class="badge rounded-pill bg-info text-white me-2 shadow-sm" style="letter-spacing:1px;">MORGEN</span>';
                    }

                    const fmtDay = g.date.toLocaleDateString('de-DE', { weekday: 'long' });
                    const fmtDate = g.date.toLocaleDateString('de-DE', { day: '2-digit', month: 'long' });

                    html += `
                    <div class="calendar-card mb-4 shadow-lg" style="border-radius: 16px; overflow: hidden; background: #1e272e; border: 1px solid ${borderColor}55; transition: all 0.3s ease;">
                        <div class="card-header d-flex align-items-center py-3" style="background: rgba(0,0,0,0.25); border-bottom: 1px solid #ffffff05;">
                            ${statusLabel}
                            <strong style="letter-spacing: 1.2px; text-transform: uppercase; font-size: 0.85rem; color: ${accentColor};">
                                ${fmtDay}, <span style="color: #ffffff99; font-weight: 300;">${fmtDate}</span>
                            </strong>
                        </div>
                        <ul class="list-group list-group-flush" style="background: transparent;">`;

                    g.items.forEach(it => {
                        html += `
                        <li class="list-group-item d-flex justify-content-between align-items-center py-3 px-4" style="background: transparent; border-bottom: 1px solid #ffffff08;">
                            <div class="d-flex align-items-center">
                                <div class="icon-box me-3 p-2 d-flex align-items-center justify-content-center" style="background: rgba(255,255,255,0.03); border-radius: 12px; border: 1px solid #ffffff10; width: 42px; height: 42px;">
                                    ${taskIcons[it.type]}
                                </div>
                                <div>
                                    <div class="fw-bold text-white" style="font-size: 1.05rem; letter-spacing: 0.3px;">${taskNames[it.type]}</div>
                                    <div class="small" style="color: #ffffff55;">
                                        <span style="color: #54a0ff; font-weight: 500;">${it.plant}</span> 
                                        <span class="mx-2" style="opacity: 0.3;">|</span> 
                                        <i class="bi bi-geo-alt"></i> ${it.location}
                                    </div>
                                </div>
                            </div>
                            <button class="btn btn-sm rounded-pill px-4 fw-bold action-btn" 
                                    onclick="performTask(${it.plantId}, '${it.type}', '‚úÖ', '${taskNames[it.type]}')"
                                    style="background: #2ed573; color: white; border: none; box-shadow: 0 4px 12px rgba(46, 213, 115, 0.2); height: 32px; font-size: 0.75rem; letter-spacing: 1px;">
                                DONE
                            </button>
                        </li>`;
                    });
                    html += '</ul></div>';
                });
                container.innerHTML = html || '<div class="text-center p-5 bg-light rounded-4 border border-dashed">üéâ <p class="mt-2 text-muted">System-Status: Alle Pflanzen optimal versorgt.</p></div>';
            } catch (e) {
                console.error(e);
                container.innerHTML = '<div class="alert alert-danger">Fehler beim API-Request an den Kalender-Dienst.</div>';
            }
        }

        // ---------- AUTH ----------
        async function checkAuth() {
            try {
                const res = await fetch("/auth/me", { credentials: "include" });
                const logoutBtn = document.getElementById("logoutBtn");
                const loginOverlay = document.getElementById("loginOverlay");
                const nameDisplay = document.getElementById("userNameDisplay");
                if (res.status === 401) {
                    loginOverlay.style.display = "flex";
                    if (logoutBtn) logoutBtn.style.display = "none";
                    if (nameDisplay) nameDisplay.classList.add("d-none");
                    return;
                }
                const user = await res.json();
                loginOverlay.style.display = "none";
                if (logoutBtn) logoutBtn.style.display = "block";
                if (nameDisplay) { nameDisplay.innerText = `Hallo, ${user.username}`; nameDisplay.classList.remove("d-none"); }
                loadTasks();
            } catch (e) { console.error(e); }
        }

        async function login() {
            const f = new FormData(); f.append("username", document.getElementById("loginUser").value); f.append("password", document.getElementById("loginPass").value);
            const res = await fetch("/auth/login", { method: "POST", body: f, credentials: "include" });
            if (res.ok) checkAuth(); else alert("Login falsch");
        }

        async function logout() { await fetch("/auth/logout", { method: "POST", credentials: "include" }); window.location.reload(); }

        document.addEventListener("DOMContentLoaded", () => {
            checkAuth();
            document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(tab => {
                tab.addEventListener('shown.bs.tab', (e) => {
                    if (e.target.id === 'wishlist-tab') loadWishlist();
                    else if (e.target.id === 'locations-tab') loadLocations();
                    else if (e.target.id === 'dashboard-tab') loadTasks();
                    else if (e.target.id === 'calendar-tab') loadCalendar();
                });
            });
        });

        async function searchPlants() {
            const q = document.getElementById('searchInput').value;
            const res = await fetch(`${API_URL}/plants/search/${q}`);
            const plants = await res.json();
            const results = document.getElementById('searchResults');
            results.innerHTML = "";
            plants.forEach(p => { results.innerHTML += `<div class="plant-card mb-2 p-3 d-flex justify-content-between align-items-center"><div><div class="fw-bold">${p.common_name}</div><div class="muted small">${p.scientific_name}</div></div><button class="btn btn-sm btn-primary" onclick="addToWishlist(${p.id})">Wunschliste</button></div>`; });
        }
        async function addToWishlist(id) { await fetch(`${API_URL}/wishlist/`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ trefle_id: id }) }); loadWishlist(); }
        function showSearchModal() { new bootstrap.Modal(document.getElementById('searchModal')).show(); }
        function showAddLocationModal() { new bootstrap.Modal(document.getElementById('addLocationModal')).show(); }
        async function createLocation() {
            const payload = { name: document.getElementById('locationName').value, light_level: parseInt(document.getElementById('locationLight').value), humidity_level: parseInt(document.getElementById('locationHumidity').value), temperature_avg: parseInt(document.getElementById('locationTemp').value), available_space_cm: parseInt(document.getElementById('locationSpace').value), has_pets_or_children: document.getElementById('locationPets').checked };
            await fetch(`${API_URL}/locations/`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); loadLocations();
        }
    </script>
</body>

</html>