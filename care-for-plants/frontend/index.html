<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Care For Plants - Vollversion</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .plant-card img {
            height: 200px;
            object-fit: cover;
        }

        .task-badge {
            font-size: 0.8rem;
            margin: 2px;
        }

        .task-overdue {
            background-color: #dc3545;
        }

        .task-today {
            background-color: #ffc107;
        }

        .task-upcoming {
            background-color: #28a745;
        }

        .toxic-warning {
            border: 3px solid #dc3545;
        }
    </style>
</head>

<body class="bg-light">

    <div class="container py-5">
        <h1 class="mb-4 text-center">üåø Care For Plants Manager</h1>

        <ul class="nav nav-tabs mb-4" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard"
                    type="button">üìä Dashboard</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="wishlist-tab" data-bs-toggle="tab" data-bs-target="#wishlist"
                    type="button">‚≠ê Wunschliste</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="locations-tab" data-bs-toggle="tab" data-bs-target="#locations"
                    type="button">üìç Standorte</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="calendar-tab" data-bs-toggle="tab" data-bs-target="#calendar"
                    type="button">
                    üìÖ Kalender
                </button>
            </li>
        </ul>

        <div class="tab-content">
            <!-- TAB 1: Dashboard -->
            <div class="tab-pane fade show active" id="dashboard">
                <div class="d-flex justify-content-center gap-2 mb-4">
                    <button class="btn btn-primary" onclick="loadTasks()">üîÑ Aktualisieren</button>
                    <button class="btn btn-success" onclick="showAddPlantModal()">‚ûï Pflanze hinzuf√ºgen</button>
                </div>
                <div id="plant-container" class="row g-4"></div>
            </div>

            <!-- TAB 2: Wunschliste -->
            <div class="tab-pane fade" id="wishlist">
                <div class="d-flex justify-content-center gap-2 mb-4">
                    <button class="btn btn-primary" onclick="loadWishlist()">üîÑ Aktualisieren</button>
                    <button class="btn btn-success" onclick="showSearchModal()">üîç Pflanze suchen</button>
                </div>
                <div id="wishlist-container" class="row g-4"></div>
            </div>

            <!-- TAB 3: Standorte -->
            <div class="tab-pane fade" id="locations">
                <div class="d-flex justify-content-center gap-2 mb-4">
                    <button class="btn btn-primary" onclick="loadLocations()">üîÑ Aktualisieren</button>
                    <button class="btn btn-success" onclick="showAddLocationModal()">‚ûï Standort anlegen</button>
                </div>
                <div id="locations-container" class="row g-4"></div>
            </div>

            <!-- TAB 4: Kalender -->
            <div class="tab-pane fade" id="calendar">
                <div class="d-flex justify-content-center gap-2 mb-4">
                    <button class="btn btn-primary" onclick="loadCalendar()">üîÑ Aktualisieren</button>
                </div>
                <div id="calendar-container"></div>
            </div>

        </div>
    </div>

    <!-- Modal: Pflanze hinzuf√ºgen -->
    <div class="modal fade" id="addPlantModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Pflanze hinzuf√ºgen</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Pflanze aus Wunschliste</label>
                        <select id="wishlistSelect" class="form-select"></select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Spitzname</label>
                        <input type="text" id="plantNickname" class="form-control" placeholder="z.B. Meine Monstera">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Standort</label>
                        <select id="locationSelect" class="form-select"></select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="button" class="btn btn-success" onclick="addPlantFromWishlist()">Hinzuf√ºgen</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Pflanze suchen -->
    <div class="modal fade" id="searchModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Pflanze suchen</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <input type="text" id="searchInput" class="form-control"
                            placeholder="z.B. Monstera, Rose, Basilikum...">
                        <button class="btn btn-primary mt-2 w-100" onclick="searchPlants()">üîç Suchen</button>
                    </div>
                    <div id="searchResults" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Standort anlegen -->
    <div class="modal fade" id="addLocationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Neuer Standort</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input type="text" id="locationName" class="form-control" placeholder="z.B. Balkon">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Lichtverh√§ltnisse (1-10)</label>
                        <input type="number" id="locationLight" class="form-control" min="1" max="10" value="5">
                        <small class="text-muted">1 = dunkel, 10 = volle Sonne</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Luftfeuchtigkeit (1-10)</label>
                        <input type="number" id="locationHumidity" class="form-control" min="1" max="10" value="5">
                        <small class="text-muted">1 = sehr trocken, 10 = sehr feucht</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Durchschnittstemperatur (¬∞C)</label>
                        <input type="number" id="locationTemp" class="form-control" value="20">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Verf√ºgbare H√∂he (cm)</label>
                        <input type="number" id="locationSpace" class="form-control" value="200">
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="locationPets">
                        <label class="form-check-label" for="locationPets">Haustiere oder Kinder vorhanden</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="button" class="btn btn-success" onclick="createLocation()">Anlegen</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Pflanzeneigenschaften bearbeiten -->
    <div class="modal fade" id="editPlantModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Eigenschaften bearbeiten</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editWishlistId">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Gie√üen (alle X Tage)</label>
                            <input type="number" id="editWater" class="form-control">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">D√ºngen (alle X Tage)</label>
                            <input type="number" id="editFertilize" class="form-control">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Lichtbedarf (1-10)</label>
                            <input type="number" id="editLight" class="form-control" min="1" max="10">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Luftfeuchtigkeit (1-10)</label>
                            <input type="number" id="editHumidity" class="form-control" min="1" max="10">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Min. Temperatur (¬∞C)</label>
                            <input type="number" id="editTempMin" class="form-control">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Max. Temperatur (¬∞C)</label>
                            <input type="number" id="editTempMax" class="form-control">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Max. H√∂he (cm)</label>
                            <input type="number" id="editHeight" class="form-control">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Bodenart</label>
                            <select id="editSoil" class="form-select">
                                <option value="universal">Universal</option>
                                <option value="sandig">Sandig</option>
                                <option value="lehmig">Lehmig</option>
                                <option value="humusreich">Humusreich</option>
                            </select>
                        </div>
                        <div class="col-12 mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="editToxic">
                            <label class="form-check-label" for="editToxic">‚ö†Ô∏è Giftig f√ºr Haustiere/Kinder</label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="button" class="btn btn-primary" onclick="savePlantEdit()">Speichern</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Standort-Details -->
    <div class="modal fade" id="locationDetailModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="locationDetailTitle">Standort Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="locationDetailContent"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Standort-Wechsel -->
    <div class="modal fade" id="movePlantModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Standort wechseln</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="move-plant-id">
                    <label class="form-label">Neuer Standort</label>
                    <select class="form-select" id="move-location-select"></select>
                    <div id="move-warning" class="alert alert-warning mt-3 d-none"></div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    <button class="btn btn-primary" onclick="submitMovePlant()">Speichern</button>
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = window.location.origin;

        // Dashboard laden
        async function loadTasks() {
            const container = document.getElementById('plant-container');
            container.innerHTML = '<div class="col-12 text-center text-muted">Lade Daten...</div>';

            try {
                const response = await fetch(`${API_URL}/dashboard/tasks`);
                const tasks = await response.json();

                container.innerHTML = "";

                if (tasks.length === 0) {
                    container.innerHTML = '<div class="col-12 text-center">Noch keine Pflanzen da. F√ºge welche hinzu!</div>';
                    return;
                }

                tasks.forEach(task => {
                    const createTaskBadge = (name, icon, days) => {
                        let badgeClass = 'task-upcoming';
                        let text = `in ${days}d`;
                        if (days < 0) {
                            badgeClass = 'task-overdue';
                            text = `${Math.abs(days)}d √ºberf√§llig`;
                        } else if (days === 0) {
                            badgeClass = 'task-today';
                            text = 'HEUTE';
                        }
                        return `<span class="badge ${badgeClass} task-badge">${icon} ${name}: ${text}</span>`;
                    };

                    const taskBadges = `
                    ${createTaskBadge('Gie√üen', 'üíß', task.days_until_watering)}
                    ${createTaskBadge('D√ºngen', 'üå±', task.days_until_fertilizing)}
                    ${createTaskBadge('Umtopfen', 'ü™¥', task.days_until_repotting)}
                    ${createTaskBadge('Schneiden', '‚úÇÔ∏è', task.days_until_pruning)}
                    ${createTaskBadge('Vermehren', 'üß¨', task.days_until_propagating)}
                `;

                    const taskIcons = { 'water': 'üíß', 'fertilize': 'üå±', 'repot': 'ü™¥', 'prune': '‚úÇÔ∏è', 'propagate': 'üß¨' };
                    const taskNames = { 'water': 'Gie√üen', 'fertilize': 'D√ºngen', 'repot': 'Umtopfen', 'prune': 'Schneiden', 'propagate': 'Vermehren' };
                    const nextTaskIcon = taskIcons[task.next_task];
                    const nextTaskName = taskNames[task.next_task];

                    const cardHtml = `
                    <div class="col-lg-4 col-md-6">
                        <div class="card shadow-sm plant-card h-100">
                            <img src="${task.image || 'https://via.placeholder.com/300?text=Kein+Bild'}" class="card-img-top" alt="${task.plant}">
                            <div class="card-body">
                                <h5 class="card-title">${task.plant}</h5>
                                <h6 class="card-subtitle mb-2 text-muted">${task.species}</h6>
                                <p class="card-text mb-2">üìç <strong>${task.location}</strong></p>
                                <div class="mb-2">${taskBadges}</div>
                                <div class="alert alert-${task.next_task_days < 0 ? 'danger' : task.next_task_days === 0 ? 'warning' : 'info'} py-2 mb-2">
                                    <strong>N√§chste Aufgabe:</strong> ${nextTaskIcon} ${nextTaskName}
                                </div>
                            </div>
                            <div class="card-footer bg-white">
                                <div class="btn-group w-100 mb-1" role="group">
                                    <button class="btn btn-sm btn-primary" onclick="waterPlant(${task.id})" title="Gie√üen">üíß</button>
                                    <button class="btn btn-sm btn-success" onclick="fertilizePlant(${task.id})" title="D√ºngen">üå±</button>
                                    <button class="btn btn-sm btn-warning" onclick="repotPlant(${task.id})" title="Umtopfen">ü™¥</button>
                                    <button class="btn btn-sm btn-info" onclick="prunePlant(${task.id})" title="Schneiden">‚úÇÔ∏è</button>
                                    <button class="btn btn-sm btn-secondary" onclick="propagatePlant(${task.id})" title="Vermehren">üß¨</button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteMyPlant(${task.id})">üóëÔ∏è</button>
                                    <button class="btn btn-sm btn-outline-primary" onclick="openMovePlantModal(${task.id})">üîÅ</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                    container.innerHTML += cardHtml;
                });

            } catch (error) {
                console.error("Fehler:", error);
                container.innerHTML = `<div class="alert alert-danger">Fehler: ${error}</div>`;
            }
        }

        async function performTask(plantId, taskType, emoji, name) {
            try {
                const response = await fetch(`${API_URL}/my-plants/${plantId}/${taskType}`, { method: 'POST' });
                if (response.ok) {
                    alert(`${emoji} ${name} erledigt!`);
                    loadTasks();
                } else {
                    alert(`‚ùå Fehler beim ${name}`);
                }
            } catch (error) {
                alert('‚ùå Fehler: ' + error);
            }
        }

        async function waterPlant(id) { await performTask(id, 'water', 'üíß', 'Gie√üen'); }
        async function fertilizePlant(id) { await performTask(id, 'fertilize', 'üå±', 'D√ºngen'); }
        async function repotPlant(id) { await performTask(id, 'repot', 'ü™¥', 'Umtopfen'); }
        async function prunePlant(id) { await performTask(id, 'prune', '‚úÇÔ∏è', 'Schneiden'); }
        async function propagatePlant(id) { await performTask(id, 'propagate', 'üß¨', 'Vermehren'); }
        async function deleteMyPlant(id) {
            if (!confirm("Pflanze wirklich entfernen?")) return;
            await fetch(`${API_URL}/my-plants/${id}`, { method: 'DELETE' });
            await loadTasks();
        }


        // Wunschliste laden
        async function loadWishlist() {
            const container = document.getElementById('wishlist-container');
            container.innerHTML = '<div class="col-12 text-center text-muted">Lade Wunschliste...</div>';

            try {
                const response = await fetch(`${API_URL}/wishlist/`);
                const wishlist = await response.json();

                container.innerHTML = "";

                if (wishlist.length === 0) {
                    container.innerHTML = '<div class="col-12 text-center">Wunschliste ist leer. Suche nach Pflanzen!</div>';
                    return;
                }

                wishlist.forEach(item => {
                    const suitableText = item.suitable_locations.length > 0
                        ? `‚úÖ Geeignet f√ºr: ${item.suitable_locations.join(', ')}`
                        : '‚ö†Ô∏è Nicht f√ºr deine Standorte geeignet';

                    const toxicClass = item.is_toxic ? 'toxic-warning' : '';
                    const toxicBadge = item.is_toxic ? '<span class="badge bg-danger">‚ö†Ô∏è GIFTIG</span>' : '';

                    const cardHtml = `
                    <div class="col-md-4">
                        <div class="card shadow-sm h-100 ${toxicClass}">
                            <img src="${item.image_url || 'https://via.placeholder.com/300?text=Kein+Bild'}" class="card-img-top" style="height: 200px; object-fit: cover;" alt="${item.common_name}">
                            <div class="card-body">
                                <h5 class="card-title">${item.common_name || item.scientific_name} ${toxicBadge}</h5>
                                <h6 class="card-subtitle mb-2 text-muted">${item.scientific_name}</h6>
                                <p class="card-text small">
                                    ‚òÄÔ∏è Licht: ${item.sunlight_requirement}/10 | üíß Feuchtigkeit: ${item.humidity_requirement}/10<br>
                                    üå°Ô∏è Temp: ${item.temperature_min}-${item.temperature_max}¬∞C | üìè Max: ${item.max_height_cm}cm<br>
                                    üå± Boden: ${item.soil_type}<br>
                                    üíß Gie√üen: alle ${item.water_frequency_days} Tage<br>
                                    <strong>${suitableText}</strong>
                                </p>
                            </div>
                            <div class="card-footer bg-white">
                                <button class="btn btn-sm btn-primary w-100 mb-1" onclick="showEditPlantModal(${item.id}, ${JSON.stringify(item).replace(/"/g, '&quot;')})">‚úèÔ∏è Bearbeiten</button>
                                <button class="btn btn-sm btn-danger w-100" onclick="removeFromWishlist(${item.id})">‚ùå Entfernen</button>
                            </div>
                        </div>
                    </div>
                `;
                    container.innerHTML += cardHtml;
                });

            } catch (error) {
                console.error("Fehler:", error);
                container.innerHTML = `<div class="alert alert-danger">Fehler: ${error}</div>`;
            }
        }

        // Standorte laden
        async function loadLocations() {
            const container = document.getElementById('locations-container');
            container.innerHTML = '<div class="col-12 text-center text-muted">Lade Standorte...</div>';

            try {
                const response = await fetch(`${API_URL}/locations/`);
                const locations = await response.json();

                container.innerHTML = "";

                if (locations.length === 0) {
                    container.innerHTML = '<div class="col-12 text-center">Noch keine Standorte angelegt.</div>';
                    return;
                }

                const detailResponses = await Promise.all(
                    locations.map(loc =>
                        fetch(`${API_URL}/locations/${loc.id}/details`).then(r => r.json())
                    )
                );

                container.innerHTML = "";

                locations.forEach((loc, idx) => {
                    const data = detailResponses[idx];
                    const actualCount = (data.actual_plants || []).length;
                    const wishCount = (data.compatible_wishlist_plants || []).length;

                    const petsBadge = loc.has_pets_or_children
                        ? '<span class="badge bg-warning">üêæ Haustiere/Kinder</span>'
                        : '';

                    const cardHtml = `
                        <div class="col-md-4">
                            <div class="card shadow-sm">
                                <div class="card-body">
                                    <h5 class="card-title">üìç ${loc.name} ${petsBadge}</h5>

                                    <div class="d-flex gap-2 mb-2">
                                        <span class="badge bg-success">üå± Vorhanden: ${actualCount}</span>
                                        <span class="badge bg-primary">‚≠ê Wunschliste passend: ${wishCount}</span>
                                    </div>

                                    <p class="card-text">
                                        ‚òÄÔ∏è Licht: ${loc.light_level}/10<br>
                                        üíß Feuchtigkeit: ${loc.humidity_level}/10<br>
                                        üå°Ô∏è Temperatur: ${loc.temperature_avg}¬∞C<br>
                                        üìè Platz: ${loc.available_space_cm}cm
                                    </p>

                                    <button class="btn btn-sm btn-info w-100"
                                        onclick="showLocationDetails(${loc.id})">
                                        üëÅÔ∏è Details anzeigen
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    container.innerHTML += cardHtml;
                });

            } catch (error) {
                console.error("Fehler:", error);
                container.innerHTML = `<div class="alert alert-danger">Fehler: ${error}</div>`;
            }
        }

        // Standort-Details anzeigen
        async function showLocationDetails(locationId) {
            try {
                const response = await fetch(`${API_URL}/locations/${locationId}/details`);
                const data = await response.json();

                const loc = data.location;
                const actual = data.actual_plants;
                const compatible = data.compatible_wishlist_plants;

                document.getElementById('locationDetailTitle').textContent = `üìç ${loc.name}`;

                let actualHTML = '<h5>üå± Vorhandene Pflanzen:</h5><div class="row g-3 mb-4">';
                if (actual.length === 0) {
                    actualHTML += '<div class="col-12">Noch keine Pflanzen an diesem Standort.</div>';
                } else {
                    actual.forEach(plant => {
                        actualHTML += `
                        <div class="col-md-3">
                            <div class="card">
                                <img src="${plant.image || 'https://via.placeholder.com/150'}" class="card-img-top" style="height: 120px; object-fit: cover;">
                                <div class="card-body p-2">
                                    <h6 class="card-title mb-0">${plant.nickname}</h6>
                                    <small class="text-muted">${plant.species}</small>
                                </div>
                            </div>
                        </div>
                    `;
                    });
                }
                actualHTML += '</div>';

                let compatibleHTML = '<h5>‚≠ê Passende Pflanzen aus Wunschliste:</h5><div class="row g-3">';
                if (compatible.length === 0) {
                    compatibleHTML += '<div class="col-12 alert alert-info">Keine passenden Pflanzen in der Wunschliste gefunden. F√ºge Pflanzen hinzu!</div>';
                } else {
                    compatible.forEach(plant => {
                        compatibleHTML += `
                        <div class="col-md-3">
                            <div class="card border-success">
                                <img src="${plant.image || 'https://via.placeholder.com/150'}" class="card-img-top" style="height: 120px; object-fit: cover;">
                                <div class="card-body p-2">
                                    <h6 class="card-title mb-0">${plant.common_name || plant.scientific_name}</h6>
                                    <small class="text-muted">${plant.scientific_name}</small>
                                </div>
                            </div>
                        </div>
                    `;
                    });
                }
                compatibleHTML += '</div>';

                document.getElementById('locationDetailContent').innerHTML = actualHTML + compatibleHTML;

                const modal = new bootstrap.Modal(document.getElementById('locationDetailModal'));
                modal.show();

            } catch (error) {
                alert('‚ùå Fehler beim Laden: ' + error);
            }
        }

        // Pflanze suchen
        async function searchPlants() {
            const query = document.getElementById('searchInput').value;
            const resultsDiv = document.getElementById('searchResults');

            if (!query) {
                alert('Bitte Suchbegriff eingeben');
                return;
            }

            resultsDiv.innerHTML = '<div class="text-center">Suche...</div>';

            try {
                const response = await fetch(`${API_URL}/plants/search/${query}`);
                const plants = await response.json();

                resultsDiv.innerHTML = "";

                if (plants.length === 0) {
                    resultsDiv.innerHTML = '<div class="alert alert-info">Keine Pflanzen gefunden</div>';
                    return;
                }

                plants.slice(0, 10).forEach(plant => {
                    const resultHtml = `
                    <div class="card mb-2">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${plant.common_name || 'Unbekannt'}</strong><br>
                                <small class="text-muted">${plant.scientific_name}</small>
                            </div>
                            <button class="btn btn-sm btn-primary" onclick="addToWishlist(${plant.id}, '${plant.scientific_name}', '${plant.common_name || ''}')">
                                ‚≠ê Zur Wunschliste
                            </button>
                        </div>
                    </div>
                `;
                    resultsDiv.innerHTML += resultHtml;
                });

            } catch (error) {
                resultsDiv.innerHTML = `<div class="alert alert-danger">Fehler: ${error}</div>`;
            }
        }

        async function addToWishlist(trefleId, scientificName, commonName) {
            try {
                const response = await fetch(`${API_URL}/wishlist/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ trefle_id: trefleId })
                });

                if (response.ok) {
                    // Modal schlie√üen
                    bootstrap.Modal.getInstance(document.getElementById('searchModal')).hide();

                    // WICHTIG: Sofort neu laden, damit man es sieht!
                    alert(`‚úÖ ${commonName || scientificName} hinzugef√ºgt!`);
                    loadWishlist();
                } else {
                    const error = await response.json();
                    alert('‚ùå Fehler: ' + error.detail);
                }
            } catch (error) {
                alert('‚ùå Fehler: ' + error);
            }
        }

        async function removeFromWishlist(id) {
            if (!confirm('Wirklich von der Wunschliste entfernen?')) return;

            try {
                const response = await fetch(`${API_URL}/wishlist/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    alert('‚úÖ Von Wunschliste entfernt');
                    loadWishlist();
                }
            } catch (error) {
                alert('‚ùå Fehler: ' + error);
            }
        }

        // Pflanzeneigenschaften bearbeiten
        function showEditPlantModal(wishlistId, plant) {
            document.getElementById('editWishlistId').value = wishlistId;

            // Zahlenwerte
            document.getElementById('editWater').value = plant.water_frequency_days || 7;
            document.getElementById('editFertilize').value = plant.fertilize_frequency_days || 30;
            document.getElementById('editLight').value = plant.sunlight_requirement || 5;
            document.getElementById('editHumidity').value = plant.humidity_requirement || 5;
            document.getElementById('editTempMin').value = plant.temperature_min || 15;
            document.getElementById('editTempMax').value = plant.temperature_max || 25;
            document.getElementById('editHeight').value = plant.max_height_cm || 100;

            // Dropdown und Checkbox
            document.getElementById('editSoil').value = plant.soil_type || 'universal';
            document.getElementById('editToxic').checked = plant.is_toxic;

            const modal = new bootstrap.Modal(document.getElementById('editPlantModal'));
            modal.show();
        }

        // 2. √Ñnderungen speichern (PUT Request)
        async function savePlantEdit() {
            const id = document.getElementById('editWishlistId').value;

            const payload = {
                water_frequency_days: parseInt(document.getElementById('editWater').value),
                fertilize_frequency_days: parseInt(document.getElementById('editFertilize').value),
                sunlight_requirement: parseInt(document.getElementById('editLight').value),
                humidity_requirement: parseInt(document.getElementById('editHumidity').value),
                temperature_min: parseInt(document.getElementById('editTempMin').value),
                temperature_max: parseInt(document.getElementById('editTempMax').value),
                max_height_cm: parseInt(document.getElementById('editHeight').value),
                soil_type: document.getElementById('editSoil').value,
                is_toxic: document.getElementById('editToxic').checked
            };

            try {
                const response = await fetch(`${API_URL}/wishlist/${id}/plant-info`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    alert('‚úÖ Eigenschaften aktualisiert!');
                    bootstrap.Modal.getInstance(document.getElementById('editPlantModal')).hide();
                    loadWishlist(); // Liste neu laden
                } else {
                    alert('Fehler beim Speichern');
                }
            } catch (error) {
                console.error(error);
                alert('Fehler: ' + error);
            }
        }

        // 3. Modal √∂ffnen: Pflanze aus Wunschliste hinzuf√ºgen
        async function showAddPlantModal() {
            // Wir brauchen erst die Wunschliste und die Standorte f√ºr die Dropdowns
            try {
                const [wishRes, locRes] = await Promise.all([
                    fetch(`${API_URL}/wishlist/`),
                    fetch(`${API_URL}/locations/`)
                ]);

                const wishlist = await wishRes.json();
                const locations = await locRes.json();

                const wishSelect = document.getElementById('wishlistSelect');
                const locSelect = document.getElementById('locationSelect');

                wishSelect.innerHTML = "";
                locSelect.innerHTML = "";

                if (wishlist.length === 0) {
                    alert("Deine Wunschliste ist leer. Suche erst nach Pflanzen!");
                    return;
                }

                wishlist.forEach(item => {
                    const opt = document.createElement('option');
                    opt.value = item.trefle_id; // WICHTIG: Wir brauchen die Trefle ID f√ºr den Import
                    opt.text = item.common_name
                        ? `${item.common_name} (${item.scientific_name})`
                        : item.scientific_name;
                    wishSelect.appendChild(opt);
                });

                if (locations.length === 0) {
                    const opt = document.createElement('option');
                    opt.text = "Erst Standort anlegen!";
                    locSelect.appendChild(opt);
                } else {
                    locations.forEach(loc => {
                        const opt = document.createElement('option');
                        opt.value = loc.id;
                        opt.text = loc.name;
                        locSelect.appendChild(opt);
                    });
                }

                new bootstrap.Modal(document.getElementById('addPlantModal')).show();

            } catch (error) {
                alert("Fehler beim Laden der Daten: " + error);
            }
        }

        // 4. Pflanze final hinzuf√ºgen (Wunschliste -> Dashboard)
        async function addPlantFromWishlist() {
            const trefleId = document.getElementById('wishlistSelect').value;
            const locationId = document.getElementById('locationSelect').value;
            const nickname = document.getElementById('plantNickname').value;

            if (!locationId || !trefleId) {
                alert("Bitte Standort und Pflanze w√§hlen.");
                return;
            }

            const payload = {
                nickname: nickname || "Meine Pflanze",
                location_id: parseInt(locationId),
                trefle_id: parseInt(trefleId)
            };

            try {
                const response = await fetch(`${API_URL}/my-plants/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    alert('‚úÖ Pflanze erfolgreich eingezogen!');
                    bootstrap.Modal.getInstance(document.getElementById('addPlantModal')).hide();
                    loadTasks(); // Dashboard aktualisieren
                } else {
                    const err = await response.json();
                    alert('Fehler: ' + err.detail);
                }
            } catch (error) {
                console.error(error);
            }
        }

        // 5. Standort anlegen Modal √∂ffnen
        function showAddLocationModal() {
            new bootstrap.Modal(document.getElementById('addLocationModal')).show();
        }

        // 6. Standort speichern
        async function createLocation() {
            const payload = {
                name: document.getElementById('locationName').value,
                light_level: parseInt(document.getElementById('locationLight').value),
                humidity_level: parseInt(document.getElementById('locationHumidity').value),
                temperature_avg: parseInt(document.getElementById('locationTemp').value),
                available_space_cm: parseInt(document.getElementById('locationSpace').value),
                has_pets_or_children: document.getElementById('locationPets').checked
            };

            try {
                const response = await fetch(`${API_URL}/locations/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    alert('‚úÖ Standort erstellt!');
                    bootstrap.Modal.getInstance(document.getElementById('addLocationModal')).hide();
                    loadLocations();
                } else {
                    alert('Fehler beim Erstellen.');
                }
            } catch (error) {
                console.error(error);
            }
        }

        // Initialen Start der App triggern
        function showSearchModal() {
            new bootstrap.Modal(document.getElementById('searchModal')).show();
        }

        // Beim Laden der Seite Dashboard anzeigen
        loadTasks();

        // --- AUTOMATISIERUNG & FIXES (Ans Ende des Scripts kopieren) ---

        // 1. Automatisch laden, wenn man den Tab wechselt
        document.addEventListener("DOMContentLoaded", () => {
            // Sofort Dashboard laden
            loadTasks();

            // Event-Listener f√ºr alle Tabs
            const tabEls = document.querySelectorAll('button[data-bs-toggle="tab"]')
            tabEls.forEach(tabEl => {
                tabEl.addEventListener('shown.bs.tab', function (event) {
                    // Welcher Tab ist jetzt aktiv?
                    if (event.target.id === 'wishlist-tab') {
                        loadWishlist(); // Automatisch Wunschliste laden
                    } else if (event.target.id === 'locations-tab') {
                        loadLocations(); // Automatisch Standorte laden
                    } else if (event.target.id === 'dashboard-tab') {
                        loadTasks(); // Automatisch Dashboard laden
                    }
                    else if (event.target.id === 'calendar-tab') {
                        loadCalendar();
                    }
                })
            })
        });

        // Kalender Script
        async function loadCalendar(days = 14) {
            const container = document.getElementById('calendar-container');
            container.innerHTML = '<div class="text-center text-muted">Lade Kalender...</div>';

            const taskIcons = { water: 'üíß', fertilize: 'üå±', repot: 'ü™¥', prune: '‚úÇÔ∏è', propagate: 'üß¨' };
            const taskNames = { water: 'Gie√üen', fertilize: 'D√ºngen', repot: 'Umtopfen', prune: 'Schneiden', propagate: 'Vermehren' };
            const taskFields = [
                ['water', 'days_until_watering'],
                ['fertilize', 'days_until_fertilizing'],
                ['repot', 'days_until_repotting'],
                ['prune', 'days_until_pruning'],
                ['propagate', 'days_until_propagating']
            ];

            try {
                const res = await fetch(`${API_URL}/dashboard/tasks`);
                const plants = await res.json();

                const today = new Date();
                const items = [];

                plants.forEach(p => {
                    taskFields.forEach(([type, field]) => {
                        const d = p[field];
                        if (d === undefined || d === null) return;
                        if (d > days) return;

                        const due = new Date(today);
                        due.setDate(today.getDate() + d);

                        items.push({
                            due,
                            daysUntil: d,
                            type,
                            plantId: p.id,
                            plant: p.plant,
                            species: p.species,
                            location: p.location
                        });
                    });
                });

                // Sort by due date
                items.sort((a, b) => a.due - b.due);

                if (items.length === 0) {
                    container.innerHTML = `<div class="alert alert-info">Keine Aufgaben in den n√§chsten ${days} Tagen üéâ</div>`;
                    return;
                }

                // Group by date
                const fmt = (dt) => dt.toLocaleDateString('de-DE', { weekday: 'long', year: 'numeric', month: '2-digit', day: '2-digit' });
                const key = (dt) => dt.toISOString().slice(0, 10);

                const groups = {};
                items.forEach(it => {
                    const k = key(it.due);
                    if (!groups[k]) groups[k] = { date: it.due, items: [] };
                    groups[k].items.push(it);
                });

                const orderedKeys = Object.keys(groups).sort();
                let html = '';

                orderedKeys.forEach(k => {
                    const g = groups[k];
                    const dayLabel = (g.items[0].daysUntil === 0) ? 'Heute' : (g.items[0].daysUntil === 1 ? 'Morgen' : '');
                    html += `
        <div class="card shadow-sm mb-3">
          <div class="card-header bg-white">
            <strong>${dayLabel ? dayLabel + ' ‚Ä¢ ' : ''}${fmt(g.date)}</strong>
          </div>
          <ul class="list-group list-group-flush">
      `;

                    g.items.forEach(it => {
                        html += `
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <div><strong>${taskIcons[it.type]} ${taskNames[it.type]}</strong></div>
              <div class="text-muted small">${it.plant} ‚Ä¢ ${it.species} ‚Ä¢ üìç ${it.location}</div>
            </div>
            <button class="btn btn-sm btn-outline-success" onclick="performTask(${it.plantId}, '${it.type}', '${taskIcons[it.type]}', '${taskNames[it.type]}')">
              Erledigt
            </button>
          </li>
        `;
                    });

                    html += `</ul></div>`;
                });

                container.innerHTML = html;

            } catch (e) {
                container.innerHTML = `<div class="alert alert-danger">Fehler: ${e}</div>`;
            }
        }

        // ---------- MOVE PLANT (Dashboard) ----------
        let moveModal;
        let moveRecommendations = []; // merken, ob ausgew√§hlter Standort empfohlen ist

        async function openMovePlantModal(plantId) {
            document.getElementById('move-plant-id').value = plantId;

            const res = await fetch(`${API_URL}/my-plants/${plantId}/recommended-locations`);
            const locations = await res.json();
            moveRecommendations = locations;

            const sel = document.getElementById('move-location-select');
            sel.innerHTML = '';

            const good = document.createElement('optgroup');
            good.label = '‚úÖ Empfohlen';

            const other = document.createElement('optgroup');
            other.label = '‚ö†Ô∏è M√∂glich, aber nicht ideal';

            locations.forEach(l => {
                const opt = document.createElement('option');
                opt.value = l.id;

                // Name + kurze Gr√ºnde nur bei "nicht empfohlen"
                opt.textContent = l.recommended
                    ? l.name
                    : `${l.name} ‚Äì ${l.reasons.join(", ")}`;

                (l.recommended ? good : other).appendChild(opt);
            });

            if (good.children.length) sel.appendChild(good);
            if (other.children.length) sel.appendChild(other);

            // Standardm√§√üig ersten empfohlenen ausw√§hlen (falls vorhanden)
            if (good.children.length) {
                sel.value = good.children[0].value;
            } else if (other.children.length) {
                sel.value = other.children[0].value;
            }

            // Warnhinweis initial setzen + bei √Ñnderung aktualisieren
            updateMoveWarning();

            sel.onchange = updateMoveWarning;

            if (!moveModal) {
                moveModal = new bootstrap.Modal(document.getElementById('movePlantModal'));
            }
            moveModal.show();
        }

        function updateMoveWarning() {
            const sel = document.getElementById('move-location-select');
            const selectedId = parseInt(sel.value, 10);

            const info = moveRecommendations.find(x => x.id === selectedId);
            const warn = document.getElementById('move-warning');

            if (!warn) return;

            if (info && !info.recommended) {
                warn.classList.remove('d-none');
                warn.textContent = `‚ö†Ô∏è Hinweis: Dieser Standort ist nicht ideal: ${info.reasons.join(", ")}. Du kannst die Pflanze trotzdem umstellen.`;
            } else {
                warn.classList.add('d-none');
                warn.textContent = '';
            }
        }

        async function submitMovePlant() {
            const plantId = document.getElementById('move-plant-id').value;
            const newLocId = parseInt(
                document.getElementById('move-location-select').value,
                10
            );

            await fetch(`${API_URL}/my-plants/${plantId}/move`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ location_id: newLocId })
            });

            moveModal.hide();
            await loadTasks();
        }
    </script>
</body>

</html>